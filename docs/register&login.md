# register & login


## mysql 表结构（user）用户表

	  `id` 				        int auto_increment primary key  自增id 主键
      `phone_num` 			    char(11) NOT NULL  用户手机号
      `device_id`               varchar(20)  NOT NULL 用户注册设备号
      `create_time` 			timestamp  NOT NULL  用户注册时间
      `user_token` 		        char(32)  NOT NULL  用户token
      `user_id` 				char(32)  用户唯一标识
      `user_password` 			varchar(20)  用户密码
      `last_login_time`         timestamp  用户上次登录时间
      `user_name`               varchar(20) 用户名
      
      ......
  		
  	  PRIMARY KEY (`id`)


## 前后端业务流程

### 注册流程

    第一个请求&响应：
    客户端打开app即是注册登录页面，点击注册进入注册页面，输入手机号，点击'获取验证码'，发送
    post请求到服务器（此次请求客户端服务器同存一份共钥进行签名，可采用signature那一套，
    明文只有手机号），参数只有手机号，服务器接收请求后获取手机号，首先在数据库中查询该手机号
    是否存在，如果已存在则返回'已注册'给客户端，未查询到记录则在服务器端生成6位的随机验证码
    然后将手机号及验证码通过请求的形式发送给运营商，运营商返回的响应状态码为成功则将手机号和
    验证码以k-v的形式存放至redis，过期时间设置为90s（配置为可修改），返回成功至客户端；
    若返回的状态码为失败则根据失败原因（手机号不存在、网络原因未发送等）返回相应的结果给客户端，
    客户端做相应判断
    
    第二个请求&响应：
    客户端收到验证码短信，60s内输入有效，60s后该按键为重新获取验证码，用户输入验证码后点击
    '下一步'，携带参数有'手机号、验证码'、'创建设备号'，发送post请求至服务器端（此次请求客户
    端服务器同存一份共钥进行签名，可采用signature那一套，），服务器端接收请求后首先在redis中查询key为
    该手机号的value，找不到该手机号对应的value则报错'验证码已失效'，找到value
    但不成功则报错'验证码错误'，解密成功则先验证该手机号是否已在用户表中存在，若存在则
    不更新数据库（存在一种情况是用户输入正确的验证码点击'下一页'发出请求，到输入密码页但用户
    不操作了，下次还注册时导致手机号已存至数据库），不存在则生成时间戳作为创建时间，
    以'手机号'、'验证码'、'创建设备号'、'创建时间'作为参数hash或其他算法生成token（token可
    以理解为每一用户的私钥，以后在一次登录过程（这个一次登录可能持续很久，用户一段时间不用仍然
    可以不用登录查看不同页面是因为依然在同一次登录过程中）中的每个请求和响应均采用token进行
    加密和解密，以后设计'不同设备要验证码'、'更换手机号'等接口时要关注这个token的使用），
    在数据库表中插入'手机号'、'创建设备号'、'创建时间'（创建时间必须由时间戳转换为MySQL认识的
    数据类型才可存至数据库）、'token'至用户表中，
    响应参数为'成功标志'、'token'，客户端拿到token存放至本地并跳转到下一页面（用户输入密码页面）
    
    第三个请求&响应：
    客户端页面为输入两遍密码的页面，点击'注册'即发送post请求，参数包括'手机号、密码'（该请求
    就以本地的token为盐进行加密，明文只有手机号），服务器端接收请求后通过明文的手机号在用户表
    数据库中查询token进行解密，解密失败则返回报错，解密成功则接收密码，同时获取当前时间戳（下文要用），
    利用'手机号'、'密码'、'当前时间戳'生成这一条记录的唯一标识'uuid'（必须保证数据库中所有
    记录的uuid绝对不同，否则以后用户多时两条记录有相同的uuid就会产生巨大问题，故不能采用简单
    的hash映射来生成uuid），以后每次请求都采用uuid来唯一标识数据库的一条记录而进行增删改查，
    将'密码'、'uuid'、'用户上次登录时间'（上文提到的时间戳转换为MySQL认识的数据类型）存放至
    数据库，然后返回'uuid'（通过token加密）的响应给客户端
    
### 登录流程

    目前未支持用户名，故在此仅阐述手机号密码登录流程：
    客户端输入手机号及密码点击登录，服务器
    端接收请求后获取明文的手机号，看数据库中是否有记录，没有则返回'未注册'，有返回'成功标志'、
    'token'、'uuid'给客户端，
    不成功则报错
    
### 本流程待优化

    以后需要完善的功能、开发过程中遇到的问题、开发过程中想到的必须做的逻辑均记录在此
    1.'忘记密码'功能
    2.'时效性'功能
    3.后期优化时发送验证码的请求要先验证是否在表中存在，存在就不要发验证码了
    4.客户端传数据为空时或者由于是application/json之类的头而导致后台数据为None时应该如何处理？
    5.用户名功能
    6.(可不做)新写接口，若客户端未发现token，需接收验证码来传递token（这就是非注册手机的机制，需考虑各种情况）